<%- include('../partials/head', { title: title }) %>

<h1>Planner â€” <%= match.name %></h1>
<a class="btn btn-link" href="/admin/series/<%= match.series_id %>/matches">â† Back to Travels</a>

<div class="card" style="margin-top:1rem;">
  <div class="travel-meta">
    <strong>Destinations:</strong> <%= match.team_a %> OR <%= match.team_b %><br>
    <strong>Start (IST):</strong>
    <%= moment.utc(match.start_time_utc).tz('Asia/Kolkata').format('YYYY-MM-DD HH:mm') %><br>
    <strong>Points:</strong> <%= match.entry_points %><br>
    <strong>Status:</strong> <%= match.status %>
  </div>
</div>

<hr>

<!-- Probable Result -->
<div class="card" style="margin:1rem 0;">
  <h3>ğŸ”® Probable Winning (After Cutoff)</h3>

  <% if (isCutoffOver) { %>
    <div style="margin-top:0.5rem;">
      <% if (probable.A.perPlanner > probable.B.perPlanner) { %>
        <p><strong><%= match.team_a %></strong> (Higher Payout)</p>
      <% } else if (probable.B.perPlanner > probable.A.perPlanner) { %>
        <p><strong><%= match.team_b %></strong> (Higher Payout)</p>
      <% } else { %>
        <p><strong>Even Odds</strong> â€” Equal Payout</p>
      <% } %>

      <table class="table" style="margin-top:0.5rem;">
        <thead>
          <tr>
            <th>Destination</th>
            <th>Planners</th>
            <th>Opposing + Missed</th>
            <th>Total Pot</th>
            <th>Per Planner</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><%= match.team_a %></td>
            <td><%= probable.A.winners %></td>
            <td><%= probable.A.losers %></td>
            <td><%= probable.A.totalPot %></td>
            <td><%= probable.A.perPlanner.toFixed(2) %></td>
          </tr>
          <tr>
            <td><%= match.team_b %></td>
            <td><%= probable.B.winners %></td>
            <td><%= probable.B.losers %></td>
            <td><%= probable.B.totalPot %></td>
            <td><%= probable.B.perPlanner.toFixed(2) %></td>
          </tr>
        </tbody>
      </table>
    </div>
  <% } else { %>
    <p>Probable result will be available after cutoff.</p>
  <% } %>
</div>


<!-- Summary -->
<div class="summary-box" style="display:flex;gap:1rem;margin:1rem 0;">
  <div class="chip chip-ok">ğŸ• <%= match.team_a %>: <%= aCount %> planners</div>
<div class="chip chip-warn">ğŸ– <%= match.team_b %>: <%= bCount %> planners</div>
</div>

<!-- Travel Planners -->
<div class="card">
  <h3>ğŸ§­ Travel Planners</h3>
  <% if (preds.length === 0) { %>
    <p>No planners yet.</p>
  <% } else { %>
    <table class="table">
      <thead>
        <tr><th>Planner</th><th>Chosen Destination</th></tr>
      </thead>
      <tbody>
        <% preds.forEach(p => { %>
          <tr>
            <td><%= p.display_name %></td>
            <td><%= p.predicted_team === 'A' ? match.team_a : match.team_b %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</div>

<!-- Admin Declare Controls -->
<% if (match.status !== 'completed' && match.status !== 'washed_out') { %>
  <hr>
  <div class="card" style="margin-top:1rem;">
    <h3>âš–ï¸ Declare Result</h3>
    <div style="display:flex;gap:1rem;flex-wrap:wrap;">

      <button class="btn btn-success declare-btn"
        data-match-id="<%= match.id %>"
        data-winner="<%= match.team_a %>">
  âœ… Declare <%= match.team_a %>
</button>

<button class="btn btn-success declare-btn"
        data-match-id="<%= match.id %>"
        data-winner="<%= match.team_b %>">
  âœ… Declare <%= match.team_b %>
</button>

<button class="btn btn-warning declare-btn-washout"
        data-match-id="<%= match.id %>">
  ğŸŒ§ Washed Out
</button>

<button class="btn btn-danger cancel-btn"
        data-match-id="<%= match.id %>">
  âŒ Cancel Travel
</button>
    </div>
  </div>
<% } %>

<script src="/js/adminPlanner.js"></script>
<%- include('../partials/foot') %>
