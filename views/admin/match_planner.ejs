<%- include('../partials/head', { title: title }) %>

<h1>Planner ‚Äî <%= match.name %></h1>
<a class="btn btn-link" href="/admin/series/<%= match.series_id %>/matches">‚Üê Back to Travels</a>

<div class="card" style="margin-top:1rem;">
  <div class="travel-meta">
    <strong>Destinations:</strong> <%= match.team_a %> OR <%= match.team_b %><br>
    <strong>Start (IST):</strong>
    <%= moment.utc(match.start_time_utc).tz('Asia/Kolkata').format('YYYY-MM-DD HH:mm') %><br>
    <strong>Points:</strong> <%= match.entry_points %><br>
    <strong>Status:</strong> <%= match.status %>
  </div>
</div>

<hr>

<!-- Probable Result -->
<div class="card" style="margin:1rem 0;">
  <h3>üîÆ Probable Winning (After Cutoff)</h3>
  <% if (isCutoffOver) { %>
  <p>
    <strong>
      <% if (probable.A.perPlanner > probable.B.perPlanner) { %>
        <%= match.team_a %>
      <% } else if (probable.B.perPlanner > probable.A.perPlanner) { %>
        <%= match.team_b %>
      <% } else { %>
        No clear winner yet.
      <% } %>
    </strong>
  </p>
<% } else { %>
  <p>Probable result will be shown after cutoff.</p>
<% } %>

</div>

<!-- Summary -->
<div class="summary-box" style="display:flex;gap:1rem;margin:1rem 0;">
  <div class="chip chip-ok">üèï <%= match.team_a %>: <%= countA %> planners</div>
  <div class="chip chip-warn">üèñ <%= match.team_b %>: <%= countB %> planners</div>
</div>

<!-- Travel Planners -->
<div class="card">
  <h3>üß≠ Travel Planners</h3>
  <% if (predictions.length === 0) { %>
    <p>No planners yet.</p>
  <% } else { %>
    <table class="table">
      <thead>
        <tr><th>Planner</th><th>Chosen Destination</th></tr>
      </thead>
      <tbody>
        <% predictions.forEach(p => { %>
          <tr>
            <td><%= p.display_name %></td>
            <td><%= p.predicted_team === 'A' ? match.team_a : match.team_b %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</div>

<!-- Admin Declare Controls -->
<% if (match.status !== 'completed' && match.status !== 'washed_out') { %>
  <hr>
  <div class="card" style="margin-top:1rem;">
    <h3>‚öñÔ∏è Declare Result</h3>
    <div style="display:flex;gap:1rem;flex-wrap:wrap;">

      <button class="btn btn-success"
              onclick="declareResult('<%= match.id %>', '<%= match.team_a %>', false)">
        ‚úÖ Declare <%= match.team_a %>
      </button>

      <button class="btn btn-success"
              onclick="declareResult('<%= match.id %>', '<%= match.team_b %>', false)">
        ‚úÖ Declare <%= match.team_b %>
      </button>

      <button class="btn btn-warning"
              onclick="declareResult('<%= match.id %>', null, true)">
        üåß Washed Out
      </button>

      <button class="btn btn-danger"
              onclick="confirmCancel('<%= match.id %>')">
        ‚ùå Cancel Travel
      </button>
    </div>
  </div>
<% } %>

<script>
  async function declareResult(matchId, winner, washed_out = false) {
    // Step 1: First confirmation
    const firstConfirm = confirm(`Are you sure you want to declare ${washed_out ? 'Washed Out' : winner}?`);
    if (!firstConfirm) return;

    // Step 2: Second confirmation
    const secondConfirm = confirm(`Final confirmation ‚Äî Proceed to declare ${washed_out ? 'Washed Out' : winner}?`);
    if (!secondConfirm) return;

    try {
      const response = await fetch(`/admin/matches/${matchId}/declare`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ winner, washed_out })
      });

      const data = await response.json();
      if (data.success) {
        alert(`‚úÖ ${data.message}`);
        location.reload();
      } else {
        alert(`‚ö†Ô∏è ${data.error || 'Declaration failed.'}`);
      }
    } catch (err) {
      console.error('Error declaring result:', err);
      alert('‚ùå Something went wrong.');
    }
  }

  async function confirmCancel(matchId) {
    const confirm1 = confirm('Are you sure you want to cancel this travel?');
    if (!confirm1) return;
    const confirm2 = confirm('Final confirmation: Cancel this travel?');
    if (!confirm2) return;

    try {
      const res = await fetch(`/admin/matches/${matchId}/reset-ledger`, {
        method: 'POST'
      });
      const data = await res.json();
      alert(data.message || data.error);
      if (data.success) location.reload();
    } catch (err) {
      alert('‚ùå Failed to cancel travel.');
    }
  }
</script>

<%- include('../partials/foot') %>
