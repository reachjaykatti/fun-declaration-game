<%- include('../partials/head', { title: title }) %>

<h1>Planner â€” <%= match.name %></h1>
<a class="btn btn-link" href="/admin/series/<%= match.series_id %>/matches">â† Back to Travels</a>

<div class="card" style="margin-top:1rem;">
  <div class="travel-meta">
    <strong>Destinations:</strong> <%= match.team_a %> OR <%= match.team_b %><br>
    <strong>Start (IST):</strong>
    <%= moment.utc(match.start_time_utc).tz('Asia/Kolkata').format('YYYY-MM-DD HH:mm') %><br>
    <strong>Points:</strong> <%= match.entry_points %><br>
    <strong>Status:</strong> <%= match.status %>
  </div>
</div>

<hr>

<!-- Probable Result -->
<div class="card" style="margin:1rem 0;">
  <h3>ğŸ”® Probable Winning (After Cutoff)</h3>
  <% if (isCutoffOver) { %>
    <p>
      <strong>
        <% if (probable.A.perPlanner > probable.B.perPlanner) { %>
          <%= match.team_a %>
        <% } else if (probable.B.perPlanner > probable.A.perPlanner) { %>
          <%= match.team_b %>
        <% } else { %>
          ğŸŸ° Equal Potential
        <% } %>
      </strong>
    </p>
  <% } else { %>
    <p>Probable result will be shown after cutoff.</p>
  <% } %>
</div>

<!-- Summary -->
<div class="summary-box" style="display:flex;gap:1rem;margin:1rem 0;">
  <div class="chip chip-ok">ğŸ• <%= match.team_a %>: <%= aCount %> planners</div>
<div class="chip chip-warn">ğŸ– <%= match.team_b %>: <%= bCount %> planners</div>
</div>

<!-- Travel Planners -->
<div class="card">
  <h3>ğŸ§­ Travel Planners</h3>
  <% if (preds.length === 0) { %>
    <p>No planners yet.</p>
  <% } else { %>
    <table class="table">
      <thead>
        <tr><th>Planner</th><th>Chosen Destination</th></tr>
      </thead>
      <tbody>
        <% preds.forEach(p => { %>
          <tr>
            <td><%= p.display_name %></td>
            <td><%= p.predicted_team === 'A' ? match.team_a : match.team_b %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</div>

<!-- Admin Declare Controls -->
<% if (match.status !== 'completed' && match.status !== 'washed_out') { %>
  <hr>
  <div class="card" style="margin-top:1rem;">
    <h3>âš–ï¸ Declare Result</h3>
    <div style="display:flex;gap:1rem;flex-wrap:wrap;">

      <button class="btn btn-success declare-btn"
        data-match-id="<%= match.id %>"
        data-winner="<%= match.team_a %>">
  âœ… Declare <%= match.team_a %>
</button>

<button class="btn btn-success declare-btn"
        data-match-id="<%= match.id %>"
        data-winner="<%= match.team_b %>">
  âœ… Declare <%= match.team_b %>
</button>

<button class="btn btn-warning declare-btn-washout"
        data-match-id="<%= match.id %>">
  ğŸŒ§ Washed Out
</button>

<button class="btn btn-danger cancel-btn"
        data-match-id="<%= match.id %>">
  âŒ Cancel Travel
</button>
    </div>
  </div>
<% } %>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // ğŸŸ¢ Normal declare buttons
  document.querySelectorAll('.declare-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const matchId = btn.dataset.matchId;
      const winner = btn.dataset.winner;

      const c1 = confirm(`Are you sure you want to declare ${winner}?`);
      if (!c1) return;
      const c2 = confirm(`Final confirmation â€” Proceed to declare ${winner}?`);
      if (!c2) return;

      try {
        const res = await fetch(`/admin/matches/${matchId}/declare`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ winner, washed_out: false })
        });
        const data = await res.json();
        alert(data.message || data.error);
        if (data.success) location.reload();
      } catch (err) {
        alert('âŒ Something went wrong.');
        console.error(err);
      }
    });
  });

  // ğŸŒ§ Washout button
  document.querySelectorAll('.declare-btn-washout').forEach(btn => {
    btn.addEventListener('click', async () => {
      const matchId = btn.dataset.matchId;
      const c1 = confirm('Are you sure you want to declare Washed Out?');
      if (!c1) return;
      const c2 = confirm('Final confirmation â€” Proceed to declare Washed Out?');
      if (!c2) return;

      try {
        const res = await fetch(`/admin/matches/${matchId}/declare`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ washed_out: true })
        });
        const data = await res.json();
        alert(data.message || data.error);
        if (data.success) location.reload();
      } catch (err) {
        alert('âŒ Something went wrong.');
        console.error(err);
      }
    });
  });

  // âŒ Cancel button
  document.querySelectorAll('.cancel-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const matchId = btn.dataset.matchId;
      const c1 = confirm('Are you sure you want to cancel this travel?');
      if (!c1) return;
      const c2 = confirm('Final confirmation: Cancel this travel?');
      if (!c2) return;

      try {
        const res = await fetch(`/admin/matches/${matchId}/reset-ledger`, { method: 'POST' });
        const data = await res.json();
        alert(data.message || data.error);
        if (data.success) location.reload();
      } catch (err) {
        alert('âŒ Failed to cancel travel.');
      }
    });
  });

});
</script>

<%- include('../partials/foot') %>
