<%- include('../partials/head', { title: title }) %>

<div class="container mt-4">
  <!-- üß≠ Breadcrumb Navigation -->
<div style="margin-bottom: 1rem;">
  <a href="/dashboard" style="
    text-decoration: none;
    color: var(--accent-color, #00897b);
    font-weight: 600;
  ">
    ‚Üê Back to Dashboard
  </a>
  <span style="color: #888;"> / </span>
  <span style="font-weight: 700;"><%= series.name %></span>
</div>

<h2 style="margin-top: 0;"><%= series.name %> ‚Äî Travel Progress</h2>
<p class="text-muted">Detailed breakdown of all travels in this series.</p>
<!-- üîç Quick Filter -->
<div class="d-flex justify-content-between align-items-center mt-3 mb-2">
  <input
    type="text"
    id="travelSearch"
    placeholder="Search travel or destination..."
    class="form-control"
    style="max-width: 300px;"
    onkeyup="filterTravels()"
  />
  <small class="text-muted">Type to filter table</small>
</div>

  <table class="table table-bordered mt-3">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Travel Name</th>
        <th>Destinations</th>
        <th>Start Time (UTC)</th>
        <th>Status</th>
        <th>Points</th>
        <th>Cumulative</th>
      </tr>
    </thead>
    <tbody>
      <% if (travels.length === 0) { %>
        <tr><td colspan="7" class="text-center text-muted">No travels available.</td></tr>
      <% } else { %>
        <% travels.forEach((t, idx) => { %>
          <tr>
            <td><%= idx + 1 %></td>
            <td><%= t.matchName %></td>
            <td><%= t.teamA %> OR <%= t.teamB %></td>
            <td><%= new Date(t.start_time_utc).toLocaleString() %></td>
            <td>
              <% if (t.status === 'completed') { %>
                ‚úÖ Completed
              <% } else if (t.status === 'scheduled') { %>
                üïì Scheduled
              <% } else { %>
                <%= t.status %>
              <% } %>
            </td>
            <td style="color: <%= t.travelPoints > 0 ? '#2e7d32' : '#888' %>; font-weight: 600;">
  <%= t.travelPoints.toFixed(2) %>
</td>
<td style="color: <%= t.cumulativePoints > 0 ? '#0277bd' : '#888' %>; font-weight: 600;">
  <%= t.cumulativePoints.toFixed(2) %>
</td>
          </tr>
        <% }); %>
      <% } %>
    </tbody>
  </table>
<button 
  class="btn btn-success mb-3"
  onclick="exportTableToCSV('<%= series.name.replace(/\\s+/g, '_') %>_travels.csv')"
>
  ‚¨áÔ∏è Download as CSV
</button>

  <div class="alert alert-info mt-3">
    <strong>Total Points Earned:</strong> <%= totalPoints.toFixed(2) %>
  </div>

  <a href="/dashboard" class="btn btn-secondary mt-3">‚Üê Back to Dashboard</a>
</div>
<!-- üîç Table Filtering + CSV Export Scripts -->
<script>
  // --- Filter Table ---
  function filterTravels() {
    const filter = document.getElementById("travelSearch").value.toLowerCase();
    const rows = document.querySelectorAll("table tbody tr");

    rows.forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(filter) ? "" : "none";
    });
  }

  // --- Export to CSV ---
  function exportTableToCSV(filename) {
    const rows = document.querySelectorAll("table tr");
    const csv = [];

    for (const row of rows) {
      const cols = row.querySelectorAll("th, td");
      const rowData = [];
      cols.forEach(col => rowData.push(`"${col.innerText.replace(/"/g, '""')}"`));
      csv.push(rowData.join(","));
    }

    const blob = new Blob([csv.join("\n")], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }
</script>

<%- include('../partials/foot') %>
